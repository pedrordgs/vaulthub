# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit checks..."

# Prevent commits to master branch
PROTECTED_BRANCH="master"
CURRENT_BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

if [ "$CURRENT_BRANCH" = "$PROTECTED_BRANCH" ]; then
    echo "${RED}‚ùå Error: Commits to '$PROTECTED_BRANCH' branch are not allowed!${NC}"
    echo "${RED}Please create a feature branch and use pull requests instead.${NC}"
    exit 1
fi
echo "${GREEN}‚úì Not on protected branch${NC}"

# Check for merge conflict markers
echo "Checking for merge conflict markers..."
CONFLICT_MARKERS=$(git diff --cached --name-only -z | xargs -0 grep -l -E '^<<<<<<< |^======= |^>>>>>>> ' 2>/dev/null || true)
if [ -n "$CONFLICT_MARKERS" ]; then
    echo "${RED}‚ùå Error: Merge conflict markers found in staged files:${NC}"
    echo "$CONFLICT_MARKERS"
    echo "${RED}Please resolve conflicts before committing.${NC}"
    exit 1
fi
echo "${GREEN}‚úì No merge conflict markers found${NC}"

# Check for large files (limit: 1MB)
echo "Checking for large files..."
LARGE_FILES=""
MAX_SIZE=1048576  # 1MB in bytes

for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Try different methods to get file size (works on Linux, macOS, BSD)
        if command -v stat >/dev/null 2>&1; then
            # Linux
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
        else
            # Fallback using wc
            size=$(wc -c < "$file" 2>/dev/null || echo 0)
        fi

        if [ "$size" -gt "$MAX_SIZE" ]; then
            # Format size for display
            if command -v numfmt >/dev/null 2>&1; then
                size_display=$(numfmt --to=iec-i --suffix=B "$size")
            else
                size_display="$size bytes"
            fi
            LARGE_FILES="${LARGE_FILES}${file} (${size_display})\n"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo "${RED}‚ùå Error: Large files detected (>1MB):${NC}"
    echo -e "$LARGE_FILES"
    echo "${RED}Please remove large files or use Git LFS before committing.${NC}"
    exit 1
fi
echo "${GREEN}‚úì No large files detected${NC}"

# Run linter fixes
echo "Running linter fixes..."
npm run lint:fix

# Check if linting passed (exits non-zero on errors or warnings)
if [ $? -ne 0 ]; then
    echo "${RED}‚ùå Linter found errors or warnings. Please fix them before committing.${NC}"
    echo "${YELLOW}Note: Warnings are treated as errors in this project.${NC}"
    exit 1
fi

echo "${GREEN}‚úì All pre-commit checks passed!${NC}"
